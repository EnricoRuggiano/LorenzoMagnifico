# Network protocol

this file show how the network protocol works and the semantic of the packet sent from server to client and viceversa.

# Server-sent packets

* CONNEST: this packet is sent by the server to communicate to the client that he has been succesfully registered into the server registry. A CONNEST message has this structure:
```
"PLAYERID" : UUID_OF_THE_PLAYER
```

* NAMECHG: this packet his sent in broadcast to all clients connected to one specific game following the recived NAMECHG message sent by the client. It contains the name, choosen by the client, which will be show during the game.
A NAMECHG message has this structure:
```
"PLAYERID" : UUID_OF_THE_PLAYER
"NAME" : CHOOSEN_NAME
```

* STATCHNG: this packet is a json-diff of the player object, i.e. contains all the changes referred to a variation of a player's status (the player's resources has been changed, the player has taken a new card,...). Because client-side initialization of Player's resources set all resources to zero, a first STATCHNG message is sent just after the server-side inizialization of player's resources (this allows a complete configuration of start player's resources simply setting them from the game configuration file, clients will adapt themself to server configuration). STATCHNG message are in this way constructed:<br>A type flag allows to specify what has been changed, i.e. if the STATCHNG message is referred to a variation of resources type-flag will be setted to **RESOURCE**; else if STATCHNG message is referred to a variation of the cards owned by the player the type-flag will be setted to **CARD**.<br> so a RESOURCE-type STATCHNG will be structured in this way:
```
"TYPE" : "RESOURCE",
"PLAYERID" : UUID_OF_THE_PLAYER,
"PAYLOAD" : {
    "WOOD" : 1,
    "COINS" : 2,
    "MILITARY" : 1,
    ...
}
```
while a CARD-type STATCHNG will have a structure like this:
```
"TYPE" : "CARD"
"PLAYERID" : UUID_OF_THE_PLAYER
"PAYLOAD" : {
    "TERRITORYCARD" : CARD_NAME,
    "CHARACTERCARD" : CARD_NAME,
    ...
}
```
a STATCHNG message is always sent in broadcast.

* CHGBOARDSTAT: this message is used to synchronize all the clients on all the changes referred to the board status. For example when cards on board must be refreshed at the end of the period a BOARD-type CHGBOARDSTAT message is sent to communicate, to all client connected, the new card layout. Or when a familiy member has been placed or a card has been taken, a FAMILY-type or a CARD-type CHGBOARDSTAT respectively tells the clients where the familiy memeber has been moved or what card has been taken.<br>According to this a BOARD-type CHGBOARDSTAT will be structured in this way:
```
"TYPE" : "BOARD",
"PAYLOAD" : [{"CARD":CARD_NAME, "REGIONID":X, "SPACEID":Y},...]
```
payload will be a 1:1 map of TowerRegions card layout (i.e. the filed Card on the client-side board of the actionSpace Y in the tower X will be set to CARD_NAME).<br>

* GMSTRT: this is the first message sent by the server when the Game thread starts. It is aimed to synchronize the clien-side model of the game, i.e. the board configuration and the number of players connected to the specific game. In this way every configuration setted on the server is automatically adapted on every client. For example if the board must have five towers, a simply change on the server board will change the client-side board, or if action spaces' bonus are customize on server-side board they will be setted in the same way on the client-side board.<br>Every action space will have a structure like this:
```
{
    "BONUS" : {
          "COINS" : 1,
          "WOOD" : 1,
          ...
    },
    "REGIONID" : X,
    "SPACEID" : Y,
    "ACTIONVALUE" : Z,
    "SINGLE" : TRUE/FALSE
}
```
If not specify, ACTIONVALUE is setted to 1 by default and SINGLE is setted true by default. The special carachter # referred to BONUS indicate that the action space has no bonus. REGIONID, SPACEID and BONUS can't be null. So a GMSTRT packet will have a format like this:
```
"BOARD" : {
    "PRODUCTIONREGION" :  [{actionspace},...],
    "HARVESREGION" : [{actionspace},...],
    "COUNCILREGION" : [{actionspace}],
    "MARKETREGION" : [{actionspace},...],
    "TOWERREGION" : [{actionspace},...],
    ....
    "TOWERREGION" : [{actionspace},...]
},
"PLAYERLIST" : [UUID_OF_THE_PLAYER1, UUID_OF_THE_PLAYER2 ,...]
```
GMSTRT is sent in broadcast and is automatically generated by the code by simply looking to the server-board configuration and player list status.


# Connection phase packet flow

when the client connects to the server throught **MsgConnection** interface it recive a **CONNEST** packet (sent by the network threads which manage the client connection, i.e. **SocketListener** for Socket connection)
